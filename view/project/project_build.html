<script src="/static/js/treegrid-dnd.js"></script>
<div class="easyui-layout" data-options="fit:true,border:false">
		<div data-options="region:'north',border:false" style="padding:5px">
			<div class="easyui-panel" style="padding:5px;height:40px;">
				<div style="float:right">
					<!--a href="#" id="project_btn_new_project" class="easyui-linkbutton" data-options="plain:true,iconCls:'icon-edit',disabled:{{ !__perm_Edit_ }}" onclick="new_project()">上移</a>
					<a href="#" id="project_btn_new_project" class="easyui-linkbutton" data-options="plain:true,iconCls:'icon-edit',disabled:{{ !__perm_Edit_ }}" onclick="new_project()">下移</a-->
					<a href="#" id="pb_btn_set_parent_as_root" class="easyui-linkbutton" data-options="plain:true,iconCls:'icon-edit',disabled:true" onclick="pb_set_task_parent_root()">置为项级</a>
				</div>
				<div>
					<a href="#" id="project_btn_new_task_root" class="easyui-linkbutton" data-options="plain:true,iconCls:'icon-add',disabled:{{ !__perm_Edit_ }}" onclick="new_task('root')">顶级任务</a>
					<a href="#" id="project_btn_new_subtask" class="easyui-linkbutton" data-options="plain:true,iconCls:'icon-add',disabled:true" onclick="new_task(gpb_select_node.id)">下属任务</a>
				</div>				
			</div>
		</div>
		<div data-options="region:'center',border:false" style="padding:5px" >
			<table id="pb_tg" class="easyui-treegrid" 
				data-options="
					rownumbers: true,
					idField: 'id',
					treeField: 'name',
					fit:true,
					onSelect:pb_tg_onSelect,
					onLoadSuccess: function(row){
						$(this).treegrid('enableDnd', row?row.id:null);
					},
					onDrop:pb_tg_onDrop
				">
				<thead>
					<tr>
						<th data-options="field:'name',formatter:pb_formatter_name" width="400">任务名称</th>
						<th data-options="field:'status',formatter:pb_formatter_status" width="80">状态</th>
						<th data-options="field:'executor_id',formatter:pb_formatter_executor" width="80" >负责人</th>						
						<th data-options="field:'planmode',formatter:pb_formatter_automode" width="80">计划模式</th>
						<th data-options="field:'rely',formatter:pb_formatter_rely" width="80" >前置任务</th>
						<th data-options="field:'plan_start_time',formatter:formatter_second_dg" width="80">计划开始时间</th>
						<th data-options="field:'plan_end_time',formatter:formatter_second_dg" width="80">计划结束时间</th>
						<th data-options="field:'start_time',formatter:pb_formatter_start_time" width="80">实际开始时间</th>
						<th data-options="field:'end_time',formatter:pb_formatter_end_time" width="80">实际结束时间</th>
						<th data-options="field:'plan_duration'" width="80">计划工时</th>
						<th data-options="field:'duration'" width="80">实际工时</th>
					</tr>
				</thead>
			</table>
		</div>
	</div>
</div>

{% include './widget/new_task.html' %}

<script type="text/javascript">
var gpb_project_id = "{{ __id }}";
var gpb_project, gpb_select_node, gpb_tasks;
var gpb_tg_id = '#pb_tg';
var gpb_userMap = {};
var gpb_taskMap = {'root':{id:'root',name:'无'}};
var gpb_taskStatusMap = {
	created: '待需求确认',
	clear: '待接收执行',
	doing: '正在执行',
	pending: '已暂停执行',
	cancel: '已取消', 
	commit: '已提交',
	completed: '已完成'
};
var gpb_has_perm_edit = {{ __perm_Edit_ }};

$(function(){	
	getJSON( '/api/project/p/'+gpb_project_id, function(err, data){
		if(!err){
			gpb_project = data;
			var ms = data.members;
			for(var i = 0; i < ms.length; i++ ){
				var m = ms[i];
				gpb_userMap[m.user_id] = m;
			}
		}
		getJSON( '/api/project/p/'+gpb_project_id + '/tasklist', function(err, data){
			if(!err){
				for( var i = 0; i < data.length; i++ ){
					var t = data[i];
					gpb_taskMap[t.id] = t;
					if( t.parent != 'root'){
						t['_parentId'] = t.parent;
					}
				}
				gpb_tasks = data;
				$(gpb_tg_id).treegrid('loadData', {"total":data.length,"rows":data});
			}
		});
	});

	
});
function pb_formatter_name(value,row,index){
	return row.milestone === 1 ? '<span style="color:#e28327">' + value + '</span>' : value;
}
function pb_formatter_executor(value,row,index){	
	return gpb_userMap[value].name;
}
var pb_status_colors = {
	doing:'#2d7091',
	commit: '#2d7091',
	completed: '#659f13'
};
function pb_formatter_status(value,row,index){
	if( pb_status_colors.hasOwnProperty(value)){
		return '<span style="color:'+ pb_status_colors[value] +'">' + gpb_taskStatusMap[value] + '</span>';
	}else{
		return gpb_taskStatusMap[value];
	}
}
function pb_formatter_duration(value,row,index){
	if( row.status === 'completed' ){
		return row.duration;
	}else{
		return row.plan_duration;
	}
}
function pb_formatter_rely(value,row,index){
	return '无';
}
function pb_formatter_automode(value,row,index){
	return row.automode === 0 ? '自动' : '手动';
}
function pb_formatter_start_time(value,row,index){
	return row.start_time === 0 ? '无' : formatter_second_dg(row.start_time);
}
function pb_formatter_end_time(value,row,index){
	return row.end_time === 0 ? '无' : formatter_second_dg(row.end_time);
}


function pb_tg_onSelect(row){
	gpb_select_node = row;
	if( gpb_has_perm_edit ){
		$('#project_btn_new_subtask').linkbutton('enable');
		if( row.hasOwnProperty('_parentId')){
			$('#pb_btn_set_parent_as_root').linkbutton('enable');
		}else{
			$('#pb_btn_set_parent_as_root').linkbutton('disable');
		}			
	}
}

function pb_tg_onDrop(targetRow,sourceRow,point){
	postJSON( '/api/project/task/'+sourceRow.id+'/move', {action:'update_parent',parent:targetRow.id}, function(err, result){
		if( !err ){
			showInfo( '更新任务成功。');
			//$(gpb_tg_id).treegrid('select',gpb_select_node.id);
		}else{
			showErrorInfo( "更新任务失败", err.message );
		}
	});
}

function pb_set_task_parent_root(){	
	postJSON( '/api/project/task/'+gpb_select_node.id+'/move', {action:'update_parent',parent:'root'}, function(err, result){
			if( !err ){
				showInfo( '更新任务成功。');
				var t = $(gpb_tg_id).treegrid('pop',gpb_select_node.id);
				$(gpb_tg_id).treegrid('append',{
					data:[t]
				});
				$(gpb_tg_id).treegrid('select',gpb_select_node.id);
				$(gpb_tg_id).treegrid('enableDnd',gpb_select_node.id);
			}else{
				showErrorInfo( "更新任务失败", err.message );
			}
	});
}	

function gpb_appendTask(tid){
	getJSON( '/api/project/task/'+tid, function(err, task){
		if(!err){
			gpb_taskMap[task.id] = task;
			gpb_tasks.push( task );
			var ts = [];
			ts.push( task );

			$(gpb_tg_id).treegrid('append',{
				parent: task.parent=='root'?'':task.parent, 
				data: ts
			});
		}
	});
}

</script>
